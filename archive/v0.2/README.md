# Model v0.2 - 训练文档

> **归档日期**: 2026-01-14  
> **版本**: v0.2  
> **状态**: 已完成训练、参数优化和回测验证

---

## 1. 模型概述

这是一个基于 LSTM 的股票涨跌预测模型，用于A股量化交易策略。

### ✅ v0.2 改进点

1. **新增涨跌停标记特征** - 添加 `is_limit_up` 和 `is_limit_down` 特征
2. **排除不可执行交易** - 买入时过滤掉已涨停的股票（实际无法买入）
3. **参数优化** - 通过网格搜索找到最优概率阈值 0.70
4. **图表改进** - 新增持仓比例变化图

### 核心指标（最优配置 prob=0.70, pos=5）

| 指标 | 值 |
|------|------|
| **回测总收益** | **+38.74%** |
| **年化收益** | **+41.46%** |
| **夏普比率** | **1.867** |
| **最大回撤** | **9.53%** |
| **胜率** | **45.0%** |
| **总交易次数** | **180** |
| **平均每笔收益** | **1.75%** |
| **盈亏比** | **1.81** |

### 训练指标

| 指标 | 值 |
|------|------|
| **验证集准确率** | 52.14% |
| **测试集准确率** | 65.48% |
| **训练样本数** | 365,256 |
| **验证样本数** | 20,292 |
| **测试样本数** | 40,584 |

---

## 2. 模型架构

### 2.1 网络结构

```
输入层 (38特征 × 60天)
    ↓
LSTM层 (hidden_size=64, num_layers=1)
    ↓
Dropout (0.5)
    ↓
全连接层 (64 → 2)
    ↓
Softmax (二分类: 涨/跌)
```

### 2.2 模型配置

| 参数 | 值 | 说明 |
|------|------|------|
| model_type | lstm | LSTM循环神经网络 |
| hidden_size | 64 | 隐藏层维度 |
| num_layers | 1 | LSTM层数 |
| dropout | 0.5 | Dropout比率 |
| num_classes | 2 | 分类数（涨/跌）|
| lookback_days | 60 | 回看天数 |

---

## 3. 特征工程

### 3.1 特征列表 (共38个特征)

#### 收益率特征 (4个)
- `ret_1` - 1日收益率
- `ret_5` - 5日收益率
- `ret_10` - 10日收益率
- `ret_20` - 20日收益率

#### 移动平均特征 (4个)
- `ma_5_ratio` - 收盘价/5日均线
- `ma_10_ratio` - 收盘价/10日均线
- `ma_20_ratio` - 收盘价/20日均线
- `ma_60_ratio` - 收盘价/60日均线

#### 波动率特征 (3个)
- `volatility_5` - 5日波动率
- `volatility_10` - 10日波动率
- `volatility_20` - 20日波动率

#### 技术指标 (5个)
- `rsi_14` - 14日RSI
- `macd_dif` - MACD DIF
- `macd_dea` - MACD DEA
- `macd_hist` - MACD柱状图
- `bb_position` - 布林带位置

#### 成交量特征 (3个)
- `volume_ratio_5` - 成交量/5日均量
- `volume_ratio_20` - 成交量/20日均量
- `turnover_ma_ratio` - 成交额/均值

#### 策略相关特征 (10个)
- `open_gap` - 开盘涨跌幅
- `price_vs_max_25` - 当前价/25日最高价
- `volume_ratio_10` - 成交量/10日均量
- `price_breakout` - 是否突破25日最高价
- `stop_loss_signal` - 是否触及止损线
- `ma_10_vs_20` - 10日均线/20日均线
- `price_vs_ma_10` - 收盘价/10日均线
- `ret_2d` - 近2日涨幅
- `price_vs_2d_max` - 收盘价/近2日最高价
- `intraday_vol_spike` - 日内最大成交量/均量

#### 早盘特征 (2个)
- `morning_vol_ratio` - 早盘成交量占比
- `morning_price_change` - 早盘涨幅

#### 市场状态特征 (5个)
- `market_ret_1` - 大盘1日收益
- `market_ret_5` - 大盘5日收益
- `market_ma_10_ratio` - 大盘相对10日均线位置
- `market_volatility` - 大盘波动率
- `stock_vs_market` - 个股相对大盘强弱

#### 🆕 涨跌停标记 (2个) - v0.2新增
- `is_limit_up` - 涨停标记 (1=涨停, 0=未涨停)
- `is_limit_down` - 跌停标记 (1=跌停, 0=未跌停)

---

## 4. 交易策略

### 4.1 买入条件

```python
# 1. 模型预测看涨概率 >= 0.70 (优化后阈值)
# 2. 股票当日未涨停 (is_limit_up == False)
# 3. 按概率排序，选取前N只股票
buy_condition = (
    (probability >= 0.70) &
    (is_limit_up == False)
)
```

### 4.2 卖出条件

```python
# 持有满5天后卖出
sell_condition = (holding_days >= 5)
```

### 4.3 仓位管理

| 参数 | 值 |
|------|------|
| 初始资金 | 1,000,000 |
| 最大持仓数 | 5 |
| 单股仓位 | 总资金 / 持仓数 |
| 持有天数 | 5天 |

---

## 5. 参数优化结果

### 5.1 网格搜索配置

测试了以下参数组合：
- 概率阈值: 0.55, 0.60, 0.65, 0.70, 0.75
- 持仓数量: 3, 5, 10

### 5.2 优化结果排序

| 配置 | 收益 | 夏普 | 回撤 | 胜率 | 交易 |
|------|------|------|------|------|------|
| **prob=0.70, pos=5** | **38.74%** | **1.867** | 9.53% | 45.0% | 180 |
| prob=0.70, pos=3 | 31.47% | 1.612 | 11.79% | 44.5% | 119 |
| prob=0.75, pos=5 | 29.24% | 1.544 | 8.25% | 46.1% | 165 |
| prob=0.65, pos=5 | 26.64% | 1.317 | 12.96% | 46.3% | 190 |
| prob=0.65, pos=10 | 21.97% | 1.208 | 10.33% | 46.5% | 327 |
| prob=0.75, pos=3 | 20.12% | 1.100 | 9.64% | 44.5% | 110 |
| prob=0.60, pos=10 | 18.93% | 1.026 | 11.88% | 45.6% | 353 |
| prob=0.60, pos=5 | 14.58% | 0.787 | 17.07% | 44.5% | 209 |
| prob=0.55, pos=5 (基准) | 11.76% | 0.644 | 18.21% | 44.8% | 221 |

### 5.3 关键发现

1. **最优概率阈值是 0.70**
   - 不是越高越好，0.75 反而下降
   - 高概率信号太少会错过机会

2. **5个持仓优于3个持仓**
   - 适度分散降低风险的同时保持收益

3. **从基准到最优提升超过3倍**
   - 收益: 11.76% → 38.74% (↑227%)
   - 夏普: 0.644 → 1.867 (↑190%)
   - 回撤: 18.21% → 9.53% (↓48%)

---

## 6. 回测详情

### 6.1 回测区间

| 项目 | 值 |
|------|------|
| 开始日期 | 2025-01-02 |
| 结束日期 | 2025-12-31 |
| 交易天数 | 236天 |

### 6.2 最优配置回测结果

| 指标 | 值 |
|------|------|
| 总收益 | +38.74% |
| 年化收益 | +41.46% |
| 夏普比率 | 1.867 |
| 最大回撤 | 9.53% |
| 胜率 | 45.0% |
| 交易次数 | 180 |
| 平均每笔收益 | 1.75% |
| 盈亏比 | 1.81 |

---

## 7. 文件清单

```
v0.2/
├── README.md                         # 本文档
├── best_model.pt                     # 最佳模型权重
├── backtest_chart_*.png              # 回测图表（含持仓比例）
├── report.json                       # 回测指标
├── daily_values.csv                  # 每日净值
└── trades.csv                        # 交易记录
```

---

## 8. 图表说明

回测图表包含三个子图：

1. **收益曲线图** - 显示策略累计收益率，标记买卖点
2. **持仓比例图** - 显示每日持仓占总资产比例（蓝色面积）和持仓数量（橙色柱状）
3. **交易记录表** - 显示最近20笔交易的详细信息

---

## 9. 使用方法

### 加载模型

```python
import torch
from pipeline.training.train_simple import LSTMModel

# 模型配置
config = {
    "input_size": 38,    # 特征数
    "hidden_size": 64,
    "num_layers": 1,
    "dropout": 0.5,
    "num_classes": 2,
}

# 加载模型
model = LSTMModel(**config)
checkpoint = torch.load(".pipeline_data/archive/v0.2/best_model.pt")
model.load_state_dict(checkpoint["model_state_dict"])
model.eval()
```

### 运行回测

```bash
# 使用最优参数运行回测
python -m pipeline.backtest.backtest --min_probability 0.70 --max_positions 5
```

---

## 10. 变更日志

### v0.2 (2026-01-14)
- ✅ 新增 `is_limit_up` 和 `is_limit_down` 特征
- ✅ 买入时排除涨停股票（不可交易）
- ✅ 参数优化：概率阈值从 0.55 提升到 0.70
- ✅ 收益从 +11.76% 提升到 +38.74%
- ✅ 夏普比率从 0.644 提升到 1.867
- ✅ 图表新增持仓比例变化图
